<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калкулятори Web App</title>
    <style>
        /* Стилҳо ҳамин тавр */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .calculator { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 100%; max-width: 400px; overflow: hidden; backdrop-filter: blur(10px); }
        .display { background: #1a1a2e; color: white; padding: 30px 20px; text-align: left; direction: ltr; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
        .calculation { font-size: 18px; color: #aaa; word-wrap: break-word; min-height: 27px; }
        .result { font-size: 36px; font-weight: bold; word-wrap: break-word; min-height: 45px; margin-top: 10px; }
        .error { color: #ff6b6b; }
        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 25px; background: #f8f9fa; }
        button { border: none; border-radius: 12px; font-size: 22px; font-weight: 600; height: 70px; cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; outline: none; user-select: none; }
        button:active { transform: scale(0.95); }
        .number { background: white; color: #333; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .number:hover { background: #f0f0f0; }
        .operator { background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%); color: white; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); }
        .operator:hover { background: linear-gradient(45deg, #3a9cf5 0%, #00d9e6 100%); }
        .equals { background: linear-gradient(45deg, #42e695 0%, #3bb2b8 100%); color: white; box-shadow: 0 4px 15px rgba(66, 230, 149, 0.3); }
        .equals:hover { background: linear-gradient(45deg, #38d085 0%, #35a1a6 100%); }
        .clear { background: linear-gradient(45deg, #ff6b6b 0%, #ffa8a8 100%); color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        .clear:hover { background: linear-gradient(45deg, #ff5252 0%, #ff8a8a 100%); }
        .zero { grid-column: span 2; }
        .header { text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .header h1 { color: white; font-size: 24px; margin-bottom: 5px; }
        .header p { color: rgba(255, 255, 255, 0.8); font-size: 14px; }
        @media (max-width: 480px) { .calculator { max-width: 100%; border-radius: 15px; } .buttons { gap: 10px; padding: 15px; } button { height: 60px; font-size: 20px; } .result { font-size: 32px; } }
        @media (max-width: 360px) { button { height: 55px; font-size: 18px; } .result { font-size: 28px; } }
    </style>
</head>
<body>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <div class="header">
        <h1>Калкулятори Telegram</h1>
        <p>Ҳисобкуниҳои худро анҷом диҳед ва натиҷаро ба бот фиристед</p>
    </div>
    
    <div class="calculator">
        <div class="display">
            <div class="calculation" id="calculation">0</div>
            <div class="result" id="result">0</div>
        </div>
        
        <div class="buttons">
            <button class="clear" onclick="clearAll()">C</button>
            <button class="clear" onclick="backspace()">⌫</button>
            <button class="operator" onclick="appendOperator('/')">/</button>
            <button class="operator" onclick="appendOperator('*')">×</button>
            
            <button class="number" onclick="appendNumber('7')">7</button>
            <button class="number" onclick="appendNumber('8')">8</button>
            <button class="number" onclick="appendNumber('9')">9</button>
            <button class="operator" onclick="appendOperator('-')">-</button>
            
            <button class="number" onclick="appendNumber('4')">4</button>
            <button class="number" onclick="appendNumber('5')">5</button>
            <button class="number" onclick="appendNumber('6')">6</button>
            <button class="operator" onclick="appendOperator('+')">+</button>
            
            <button class="number" onclick="appendNumber('1')">1</button>
            <button class="number" onclick="appendNumber('2')">2</button>
            <button class="number" onclick="appendNumber('3')">3</button>
            <button class="equals" onclick="calculate()" rowspan="2">=</button>
            
            <button class="number zero" onclick="appendNumber('0')">0</button>
            <button class="number" onclick="appendDecimal()">.</button>
        </div>
    </div>

    <script>
        /**
         * Калкулятори комил бо тартиби дурусти амалҳо
         * Версияи содашуда бо тугмаҳои коркунанда
         */
        
        let calculator = null;
        
        class Calculator {
            constructor() {
                this.currentInput = '0';
                this.calculation = '';
                this.lastResult = null;
                this.isError = false;
                
                // Афзалияти операторҳо
                this.precedence = {
                    '+': 1,
                    '-': 1,
                    '*': 2,
                    '/': 2
                };
                
                this.updateDisplay();
            }
            
            appendNumber(num) {
                if (this.isError) this.clearError();
                
                if (this.currentInput === '0' || this.lastResult !== null) {
                    this.currentInput = num;
                    this.lastResult = null;
                } else {
                    this.currentInput += num;
                }
                this.updateDisplay();
            }
            
            appendDecimal() {
                if (this.isError) this.clearError();
                
                if (this.lastResult !== null) {
                    this.currentInput = '0.';
                    this.lastResult = null;
                } else if (!this.currentInput.includes('.')) {
                    this.currentInput += '.';
                }
                this.updateDisplay();
            }
            
            appendOperator(op) {
                if (this.isError) this.clearError();
                
                // Табдили операторҳои намоишӣ
                if (op === '×') op = '*';
                if (op === '÷') op = '/';
                
                // Агар currentInput маълумот дошта бошад
                if (this.currentInput !== '' && this.currentInput !== '0') {
                    this.calculation += this.currentInput + ' ' + op + ' ';
                    this.currentInput = '';
                } else if (this.calculation !== '') {
                    // Иваз кардани оператори охирин
                    const parts = this.calculation.trim().split(' ');
                    if (parts.length > 0 && this.isOperator(parts[parts.length - 1])) {
                        parts[parts.length - 1] = op;
                        this.calculation = parts.join(' ') + ' ';
                    } else {
                        this.calculation += op + ' ';
                    }
                }
                
                this.updateDisplay();
            }
            
            isOperator(token) {
                return ['+', '-', '*', '/'].includes(token);
            }
            
            clearAll() {
                this.currentInput = '0';
                this.calculation = '';
                this.lastResult = null;
                this.isError = false;
                this.updateDisplay();
            }
            
            clearError() {
                this.isError = false;
                document.getElementById('result').classList.remove('error');
            }
            
            backspace() {
                if (this.isError) {
                    this.clearAll();
                    return;
                }
                
                if (this.currentInput.length > 1) {
                    this.currentInput = this.currentInput.slice(0, -1);
                } else {
                    this.currentInput = '0';
                }
                this.updateDisplay();
            }
            
            /**
             * Алгоритми сода барои ҳисоб кардан бо тартиби амалҳо
             */
            safeEval(expression) {
                // Тоза кардани ифода
                expression = expression.replace(/×/g, '*').replace(/÷/g, '/');
                
                // Алгоритми ду марҳила:
                // 1. Аввал * ва /-ро иҷро кун
                // 2. Сипас + ва --ро иҷро кун
                
                // Ҷудо кардани рақамҳо ва операторҳо
                const tokens = expression.match(/(\d+\.?\d*|[+\-*/])/g);
                
                if (!tokens || tokens.length === 0) {
                    throw new Error("Ифода холӣ аст");
                }
                
                // Аввал зарб ва тақсимро иҷро кун
                let i = 0;
                while (i < tokens.length) {
                    if (tokens[i] === '*' || tokens[i] === '/') {
                        const left = parseFloat(tokens[i - 1]);
                        const right = parseFloat(tokens[i + 1]);
                        
                        if (isNaN(left) || isNaN(right)) {
                            throw new Error("Ифода нодуруст");
                        }
                        
                        let result;
                        if (tokens[i] === '*') {
                            result = left * right;
                        } else {
                            if (right === 0) {
                                throw new Error("Тақсим бар сифр мумкин нест");
                            }
                            result = left / right;
                        }
                        
                        // Иваз кардани се элемент бо як натиҷа
                        tokens.splice(i - 1, 3, result.toString());
                        // i-ро ба қадри дуруст баргардон
                        i = i - 1;
                    }
                    i++;
                }
                
                // Сипас ҷамъ ва тарҳро иҷро кун
                let result = parseFloat(tokens[0]);
                for (let i = 1; i < tokens.length; i += 2) {
                    const operator = tokens[i];
                    const nextNum = parseFloat(tokens[i + 1]);
                    
                    if (operator === '+') {
                        result += nextNum;
                    } else if (operator === '-') {
                        result -= nextNum;
                    }
                }
                
                return result;
            }
            
            calculate() {
                if (this.isError) {
                    this.clearAll();
                    return;
                }
                
                try {
                    // Сохтани ифодаи пурра
                    let fullExpression = (this.calculation + this.currentInput).trim();
                    
                    if (!fullExpression) {
                        this.showError("Ифода холӣ аст");
                        return;
                    }
                    
                    // Санҷиши вуруди дуруст
                    if (!this.isValidExpression(fullExpression)) {
                        this.showError("Ифода нодуруст");
                        return;
                    }
                    
                    // Ҳисоб кардан
                    const result = this.safeEval(fullExpression);
                    
                    // Санҷиши натиҷа
                    if (isNaN(result) || !isFinite(result)) {
                        throw new Error("Ҳисобкунӣ нодуруст");
                    }
                    
                    // Намоиши натиҷа
                    this.lastResult = this.formatResult(result);
                    this.calculation = fullExpression + ' =';
                    this.currentInput = this.lastResult;
                    
                    // Фиристодани натиҷа ба бот
                    this.sendToBot(result);
                    
                } catch (error) {
                    this.showError(error.message);
                } finally {
                    this.updateDisplay();
                }
            }
            
            isValidExpression(expr) {
                // Санҷиши асосии ифода
                expr = expr.replace(/×/g, '*').replace(/÷/g, '/');
                
                // Набояд бо оператор оғоз ё анҷом шавад
                if (/^[+*/]/.test(expr) || /[+*/\-]$/.test(expr)) {
                    return false;
                }
                
                // Набояд ду оператор пайдарпам бошад
                if (/[+*/\-]{2,}/.test(expr)) {
                    return false;
                }
                
                return true;
            }
            
            formatResult(num) {
                // Раванди дақиқ кардан
                const rounded = Math.round(num * 10000000000) / 10000000000;
                
                // Тоза кардани сифрҳои иловагии даҳӣ
                if (Number.isInteger(rounded)) {
                    return rounded.toString();
                } else {
                    // Маҳдуд кардани ба 10 рақами даҳӣ
                    return parseFloat(rounded.toFixed(10)).toString();
                }
            }
            
            sendToBot(result) {
                try {
                    if (window.Telegram && window.Telegram.WebApp) {
                        const formattedResult = this.formatResult(result);
                        
                        // Фиристодани маълумот ба бот
                        window.Telegram.WebApp.sendData(`RESULT: ${formattedResult}`);
                        
                        // Пӯшидани Web App
                        setTimeout(() => {
                            window.Telegram.WebApp.close();
                        }, 500);
                    } else {
                        // Барои тести браузер
                        console.log(`Натиҷа: ${result}`);
                        alert(`Натиҷа: ${result}\n(Дар Telegram ба бот фиристода мешавад)`);
                    }
                } catch (error) {
                    console.error("Хатогӣ дар фиристодани маълумот:", error);
                }
            }
            
            showError(message) {
                this.isError = true;
                document.getElementById('result').classList.add('error');
                this.currentInput = `Хатогӣ: ${message}`;
            }
            
            updateDisplay() {
                document.getElementById('calculation').textContent = this.calculation || '0';
                document.getElementById('result').textContent = this.currentInput || '0';
            }
            
            /**
             * Функсияҳои тестӣ
             */
            test() {
                console.log("=== Тести Калкулятор ===");
                
                const tests = [
                    { expr: "2+2*2", expected: 6 },
                    { expr: "9*4", expected: 36 },
                    { expr: "10/2", expected: 5 },
                    { expr: "3+4*2", expected: 11 },
                    { expr: "8/2*4", expected: 16 },
                    { expr: "2.5+3.5", expected: 6 },
                    { expr: "5-3+2", expected: 4 },
                ];
                
                tests.forEach(test => {
                    try {
                        const result = this.safeEval(test.expr);
                        console.log(`${test.expr} = ${result} ${Math.abs(result - test.expected) < 0.000001 ? '✅' : '❌'}`);
                    } catch (error) {
                        console.log(`${test.expr} -> Хатогӣ: ${error.message} ❌`);
                    }
                });
            }
        }
        
        // Функсияҳои глобалӣ барои тугмаҳо
        function appendNumber(num) {
            if (!calculator) initCalculator();
            calculator.appendNumber(num);
        }
        
        function appendDecimal() {
            if (!calculator) initCalculator();
            calculator.appendDecimal();
        }
        
        function appendOperator(op) {
            if (!calculator) initCalculator();
            calculator.appendOperator(op);
        }
        
        function calculate() {
            if (!calculator) initCalculator();
            calculator.calculate();
        }
        
        function clearAll() {
            if (!calculator) initCalculator();
            calculator.clearAll();
        }
        
        function backspace() {
            if (!calculator) initCalculator();
            calculator.backspace();
        }
        
        function initCalculator() {
            if (!calculator) {
                calculator = new Calculator();
            }
        }
        
        // Функсияҳои тести глобалӣ
        window.runTests = () => {
            initCalculator();
            calculator.test();
        };
        
        window.testExpr = (expr) => {
            initCalculator();
            try {
                const result = calculator.safeEval(expr);
                console.log(`${expr} = ${result}`);
                return result;
            } catch (error) {
                console.log(`${expr} -> Хатогӣ: ${error.message}`);
                return error.message;
            }
        };
        
        // Оғоз кардани Web App
        document.addEventListener('DOMContentLoaded', function() {
            // Сохтани калкулятор
            initCalculator();
            
            // Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                
                // Илова кардани тугмаи пӯшидан
                if (window.Telegram.WebApp.MainButton) {
                    window.Telegram.WebApp.MainButton.setText('Пӯшидан');
                    window.Telegram.WebApp.MainButton.onClick(() => {
                        window.Telegram.WebApp.close();
                    });
                    window.Telegram.WebApp.MainButton.show();
                }
            }
            
            // Дастгирии клавиатура
            document.addEventListener('keydown', function(event) {
                const key = event.key;
                
                if (key >= '0' && key <= '9') {
                    appendNumber(key);
                } else if (key === '.') {
                    appendDecimal();
                } else if (['+', '-'].includes(key)) {
                    appendOperator(key);
                } else if (key === '*') {
                    appendOperator('×');
                } else if (key === '/') {
                    appendOperator('/');
                } else if (key === 'Enter' || key === '=') {
                    event.preventDefault();
                    calculate();
                } else if (key === 'Escape' || key === 'Delete') {
                    clearAll();
                } else if (key === 'Backspace') {
                    backspace();
                } else if (key === 't' && event.ctrlKey) {
                    // Ctrl+T барои тест
                    event.preventDefault();
                    runTests();
                }
            });
            
            // Огоҳӣ
            console.log("✅ Калкулятор омода аст!");
            console.log("Барои тест, дар консол runTests()-ро даъват кунед");
            
            // Авто-тести хурд
            setTimeout(() => {
                console.log("\n=== Автотест ===");
                testExpr("2+2*2");
                testExpr("9*4");
                testExpr("10/2");
            }, 1000);
        });
    </script>
</body>
</html>